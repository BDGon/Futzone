<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Panel | FUTZONE</title>
    <link rel="stylesheet" href="res/bootstrap@5.2.0.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Teko:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --futzone-blue: #00b4d8; --futzone-dark: #111827; }
        body { background-color: var(--futzone-dark); color: white; font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 80px;}
        h1, h2, h3, .modal-title { font-family: 'Teko', sans-serif; text-transform: uppercase; }

        .card-info {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151; border-radius: 16px; padding: 20px; text-align: center;
        }
        .card-turno {
            background-color: #1f2937; border-left: 5px solid var(--futzone-blue);
            border-radius: 8px; padding: 15px; margin-bottom: 15px;
        }
        .btn-reservar {
            background-color: var(--futzone-blue); color: #111827; border: none; font-weight: bold;
            font-family: 'Teko'; font-size: 1.1rem; padding: 5px 15px; width: 100%;
            clip-path: polygon(5% 0, 100% 0, 100% 100%, 0% 100%);
        }
        
        /* MODAL */
        .modal-content { background-color: #1f2937; border: 1px solid var(--futzone-blue); color: white; }
        .btn-close-white { filter: invert(1); }

        /* --- MODO APP EN PC --- */
        @media (min-width: 768px) {
            html { background-color: #050505; }
            body {
                max-width: 480px; margin: 0 auto; min-height: 100vh;
                background-color: #111827; border-left: 1px solid #333; border-right: 1px solid #333;
                position: relative;
            }
            .navbar { max-width: 480px; left: 50%; transform: translateX(-50%); width: 100%; position: fixed; }
            .container { padding-top: 80px; }
            .modal-dialog { max-width: 440px; margin: 1.75rem auto; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark mb-4 sticky-top border-bottom border-secondary">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="navbar-brand h1 m-0">MI <span style="color:var(--futzone-blue)">ZONA</span></span>
            <button id="btnSalir" class="btn btn-sm btn-outline-secondary">SALIR</button>
        </div>
    </nav>

    <div class="container">
        <div class="mb-4">
            <h2 class="mb-3">HOLA, <span id="txtNombre" class="text-info">SOCIO</span></h2>
            <div class="card-info">
                <small class="text-secondary text-uppercase">Tus Clases Disponibles</small>
                <div id="txtClases" class="display-1 fw-bold text-white my-2">-</div>
                <div id="txtEstado" class="badge bg-secondary">Cargando...</div>
            </div>
        </div>
        <hr class="border-secondary my-4">
        <h3 class="mb-3">üìÖ PR√ìXIMAS CLASES</h3>
        <div id="listaTurnos" class="text-center text-secondary">Buscando horarios...</div>
    </div>

    <div class="modal fade" id="modalAviso" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-info">üì¢ INFORMACI√ìN</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <p class="fs-5">Recuerda que a partir de <strong>febrero 2026</strong> la cuota mensual se pagar√° del <strong>1 al 10</strong> de cada mes.</p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">ENTENDIDO</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { auth } from './js/firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { consultarEstadoExcel, obtenerTurnos, reservarTurno } from './js/sheet-api.js';

        let userEmail = "";
        let clasesDisponibles = 0;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userEmail = user.email;
                cargarDatosUsuario(userEmail);
                cargarTurnos(userEmail);
                if (!sessionStorage.getItem('avisoVisto')) {
                    new bootstrap.Modal(document.getElementById('modalAviso')).show();
                    sessionStorage.setItem('avisoVisto', 'true');
                }
            } else { location.href = "login.html"; }
        });

        async function cargarDatosUsuario(email) {
            const data = await consultarEstadoExcel(email);
            if (data?.result === "success") {
                const u = data.data;
                document.getElementById('txtNombre').innerText = u.nombre.split(" ")[0];
                clasesDisponibles = parseInt(u.clases);
                document.getElementById('txtClases').innerText = clasesDisponibles;
                const est = document.getElementById('txtEstado');
                est.innerText = u.estado === "AL DIA" ? "HABILITADO" : "PAGO PENDIENTE";
                est.className = u.estado === "AL DIA" ? "badge bg-success" : "badge bg-danger";
            }
        }

        async function cargarTurnos(email) {
            const container = document.getElementById('listaTurnos');
            const turnos = await obtenerTurnos(email);
            container.innerHTML = "";
            if (turnos.length === 0) return container.innerHTML = "No hay clases programadas.";

            turnos.forEach(t => {
                const dia = new Date(t.fecha).toLocaleDateString('es-AR', {weekday:'long', day:'numeric', month:'short'});
                let btn = `<button onclick="reservar('${t.id}','${t.actividad}','${t.hora}')" class="btn-reservar">RESERVAR</button>`;
                if (t.yaInscrito) btn = `<button class="btn btn-success w-100" disabled>YA EST√ÅS ANOTADO</button>`;
                else if (t.ocupados >= t.cupo) btn = `<button class="btn btn-secondary w-100" disabled>LLENO</button>`;

                container.innerHTML += `
                <div class="card-turno">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div><div class="fw-bold fs-4 text-uppercase" style="font-family:'Teko'">${t.actividad}</div><div class="text-info">${dia} | ${t.hora} hs</div></div>
                        <div class="text-center bg-dark p-2 rounded border border-secondary">
                            <div class="fw-bold">${t.cupo - t.ocupados}</div><small style="font-size:0.6rem">LIBRES</small>
                        </div>
                    </div>
                    ${btn}
                </div>`;
            });
        }

        window.reservar = async (id, act, hora) => {
            if (clasesDisponibles <= 0) return alert("Sin clases disponibles.");
            if (!confirm(`¬øReservar ${act} a las ${hora}?`)) return;
            alert(await reservarTurno(userEmail, id) ? "‚úÖ Reserva Exitosa" : "‚ùå Error o Cupo Lleno");
            location.reload();
        };

        document.getElementById('btnSalir').onclick = () => { sessionStorage.removeItem('avisoVisto'); signOut(auth).then(()=> location.href="login.html"); };
    </script>
</body>
</html>
